
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % function[Yte] = predif2(Xtr, Htr, Ytr, Xte, Hte, sigma3)
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % Kernel hammer:
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % k3=@(x,y) 0.9998*ones(size(pdist2(x,y)));
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % Gaussian kernel:
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % k3=@(x,y) exp(-pdist2(x,y).^2/(2*sigma3^2));
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % Monomial Kernel:
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % k3=@(x,y) (x*y'+sigma3).^2;
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % Matérn Kernel with nu=3/2:
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % k3=@(x,y) (1+sqrt(3)*pdist2(x,y)/sigma3).*exp(-sqrt(3)*pdist2(x,y)/sigma3);
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % Matérn Kernel with nu=5/2:
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % k3=@(x,y) (1+sqrt(3)*pdist2(x,y)/sigma3+5*pdist2(x,y).^2/(3*sigma3^2)).*exp(-sqrt(5)*pdist2(x,y)/sigma3);
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % %Simplified Matérn Kernel with nu=5/2:
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % k3=@(x,y) exp(-sqrt(5)*pdist2(x,y)/sigma3);
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % n = size(Xtr,1);
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % Ktrtr3 = k3(Xtr,Xtr);
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % Ktetr3 = k3(Xte,Xtr);
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % C = ((Htr*Htr').*Ktrtr3 + 10^8*Ktrtr3 + 0.00001*n*eye(n))\Ytr; 
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % %on a pris une valeur arbitraire de lambda à 10^-5 qui semble donner de bons résultats... Pourquoi? Aucune idée.
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 
% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % Yte = ((Hte*Htr').*Ktetr3 + 10^8*Ktetr3)*C;



function[A] = predif2(X,H,Y,sigma,c)

n = size(Y,1);
lambda = 10^-5;
k=@(x,y) exp(-sqrt(5)*pdist2(x,y)/sigma);
K = k(X,X);

eps=@(x) exp(c*x)-c*x-1; % eps
deps=@(x) c*(exp(c*x)-1); % eps'
f=@(A) sum(eps(Y-H.*(K*A(:,1))-10^4*(K*A(:,2))))/n + lambda*(A(:,1)'*K*A(:,1) + A(:,2)'*K*A(:,2)); % f
inter=@(A) K*deps(Y-H.*(K*A(:,1))-10^4*K*A(:,2))/n;
g=@(A) 2*lambda*K*A-[H.*inter(A),10^4*inter(A)];  % df
h=@(A) sum(sum(g(A).^2)); % ||df||^2

A = 2/sqrt(n)*rand(n,2)-1/sqrt(n); % demander à Emile
V = g(A);
while max(abs(V))>10^-3
    V = g(A);
    A = A-f(A)*V/h(A);
    max(abs(V))
end